name: Auto Create PRs

on:
  push:
    branches:
      - main

jobs:
  createPR:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Configure Git identity
        run: |
          git config --global user.email "shivamnaik6574@gmail.com"
          git config --global user.name "shivamnaik6574"

      - name: Set up GitHub CLI
        run: |
          echo "env:
            GH_TOKEN: \${{ secrets.GITHUB_TOKEN }}" > $GITHUB_ENV

      - name: Install GitHub CLI
        run: |
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key C99B11DEB97541F0
          sudo apt-add-repository https://cli.github.com/packages
          sudo apt-get update
          sudo apt-get install gh          

      - name: Create PRs for each commit
        run: |
          IFS=$'\n'
          for commit in $(git log --format=%H); do
            echo "Creating PR for commit: $commit"
            git checkout -b "auto-pr-branch-$commit" $commit
            echo "Changes for commit $commit" > description.txt
            git add description.txt
            git commit --amend --no-edit
            git push origin "auto-pr-branch-$commit"
            
            gh pr create --base main --head "auto-pr-branch-$commit" --title "Auto PR for commit $commit" --body "$(cat description.txt)"
          done

