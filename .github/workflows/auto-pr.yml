name: Auto PR Workflow

on:
  push:
    branches:
      - main
      - auto-pr-branch

jobs:
  create_auto_pr:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up GitHub CLI
      run: |
        echo "Setting up GitHub CLI"
        sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key C99B11DEB97541F0
        sudo apt-add-repository https://cli.github.com/packages
        sudo apt-get update
        sudo apt-get install gh

    - name: Create Auto-PR
      run: |
        COMMIT_MESSAGE=$(git log --format=%B -n 1 $GITHUB_SHA)
        PR_BRANCH="auto-pr-branch-$(echo $COMMIT_MESSAGE | tr -d '[:space:]' | cut -c 1-8)"

        git checkout -b $PR_BRANCH
        git push origin $PR_BRANCH

        gh pr create --base main --head $PR_BRANCH --title "Auto-PR: $COMMIT_MESSAGE" --body "This PR is automatically generated for commit: $GITHUB_SHA"

      env:
        PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        TOKEN: ${{ secrets.TOKEN }}
